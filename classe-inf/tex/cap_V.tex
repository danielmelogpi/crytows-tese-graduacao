\chapter{Proposta de chaveiro pessoal móvel acessível por Webservices}
\label{cap:propostaChaveiroWS}

% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
\section{Descrição da proposta}
\label{sec:descricaoProposta} 
Neste trabalho propõe-se uma solução para as dificuldades com configuração de ambiente e mobilidade do chaveiro, dando ao usuário a capacidade de manter consigo o chaveiro PGP com seus recursos privados de criptografia e, ainda assim, ser capaz de utilizar tais recursos nas aplicações com as quais interage cotidianamente em suas estações de trabalho.

O capítulo 4 apresentamos formas de acesso ao chaveiro estão concentradas em bibliotecas e outros softwares na estação de trabalho.. Buscamos neste trabalho oferecer uma interface única de acesso ao chaveiro por meio de webservices seguindo a filosofia REST. É esperado que isso simplifique a manutenção do chaveiro pelo usuário final. Também espera-se  contribuir com o desenvolvimento de aplicações que usam os recursos do chaveiro, de forma que possam usar os webservices de forma centralizada e ubíqua e seja desnecessário ter a instalação em várias estações de trabalho espalhadas. cada estação de trabalho.

Para que aplicações de terceiros consigam realizar as operações necessárias, como criptografar, assinar, descriptografar e verificar assinatura, é necessário um canal de comunicação para que as aplicações localizadas nas estações de trabalho possam acessar o chaveiro e fazer uso dos recursos criptográficos agora protegidos enclausurados no dispositivo móvel. Para este fim, é proposta neste trabalho uma camada de serviço implementando estas operações como  web services.

A principal vantagem do uso de  web services é a simplicidade de uso por parte das aplicações clientes. Como este é um protocolo bem conhecido o desenvolvedor do cliente poderá usar bibliotecas já testadas para a sua linguagem de escolha. Somado a isto, o uso de REST com JSON torna esta API simples e transparente algo mais familiar para o desenvolvedor, visto que estas tecnologias são conhecidas e suportadas em todas as grandes linguagens de programação e são plenamente provadas no mercado.

Usando chamadas remotas de webservice será possível fazer uso dos recursos independente de uma instalação na máquina cliente dedicada à manipulação das chaves conhecidas, mantendo todo o arcabouço de segurança de interesse do usuário centralizado em seu dispositivo. 

Para isso será usada uma uma implementação de chaveiro criptográfico disponível para Android chamada Open KeyChain \cite{openKeyChain}. Ela implementa um chaveiro PGP com uma interface simples para o usuário final. Essa ferramenta de código aberto dá suporte completo à geração de chaves privadas, importação de chaves públicas de diversos servidores comunitários, criptografia, descriptografia, assinatura e verificação de assinaturas no conteúdo desejado. Note-se que esta aplicação já se encontra pronta para uso na plataforma Android.

O escopo deste trabalho está em demonstrar a viabilidade do uso de um chaveiro criptográfico em dispositivo móvel por meio de consultas HTTP aos  web services desenvolvidos, na forma de um um software com serviços desenvolvidos para demonstrar essa viabilidade e testar a proposta. 

Abaixo uma representação simplificada da proposta, exibindo os principais elementos envolvidos numa operação de criptografia:


\begin{figure}[H]
 \centering
 \includegraphics[width=0.9\textwidth]{./fig/diagrama-tunel.png}
 \caption{representação de uma operação de criptografia com chaveiro em dispositivo móvel}
 \label{fig:exemploFig2}
\end{figure}

Quando necessário, será pedida na tela do usuário a senha de sua chave privada para realizar operações de assinatura e descriptografia. 

\begin{figure}[H]
 \centering
 \includegraphics[width=0.9\textwidth]{./fig/diagrama-senha.png}
 \caption{ilustração de como a chamada de um serviço criptográfico aciona o Open KeyChain que, por sua vez, pede a senha do chaveiro do usuário para proceder}
 \label{fig:exemploFig2}
\end{figure}


\begin{figure}[H]
 \centering
 \includegraphics[width=0.4\textwidth]{./fig/pedir-senha-alice}
 \caption{Captura de tela da aplicação Open KeyChain pedindo a senha da chave privada para o usuário alice@email.com}
 \label{fig:exemploFig2}
\end{figure}

\section{Operações dos Webservices}
\label{sec:operacoesWebservices} 

Os webservices respondem através de um servidor web em execução no dispositivo móvel. Aplicações clientes capazes de enviar mensagens no formato especificado à frente poderão usufruir dos recursos do chaveiro no celular.

A forma de implementação desta demonstração adota um modelo assíncrono para as operações de criptografia e descriptografia. Essa forma foi escolhida pois os aplicativos móveis são geralmente desenvolvidos explorando-se recursos assíncronos e o webservice precisa tratar os casos em que o usuário deve interagir com a tela sem bloquear as chamadas ao serviço de forma indefinida. Dessa forma, contamos na demonstração deste trabalho com quatro operações básicas, sendo duas delas de pedido e duas de consulta de resultados destes. As operações são as seguintes:
\begin{itemize}
\item Pedido para criptografar um novo conteúdo  endereçado à um destinatário
\item Consulta a um pedido de criptografia anterior
\item Pedido para descriptografar um novo conteúdo recebido 
\item Consulta a um pedido de descriptografia realizado anteriormente
\end{itemize}


Seguem nas próximas subseções o detalhamento destes serviços.

\subsection{Autorização para utilizar os serviços}
\label{sec:autoriServicos}
Para que uma aplicação cliente utilize os serviços ela deve usar uma chave de segurança gerada no aplicativo móvel.
Todas as requisições devem contar com o cabeçalho Authorization preenchido com uma chave aleatória, exposta no dispositivo do usuário. A aplicação cliente deve ser atualizada com a chave atual, do contrário as suas requisições serão negadas pelo serviço. com o código HTTP 403 - Unauthorized e uma mensagem indicando que a chave está vazia ou incorreta.

\subsection{Criptografar um novo conteúdo}
\label{sec:servicoCriptografa}


Esta operação demanda um conteúdo textual para ser encriptado e o e-mail do destinatário. A chave pública do destinatário deve estar importada na instalação do Open KeyChain no dispositivo móvel.


\begin{figure}[H]
 \centering
 \includegraphics[width=0.9\textwidth]{./fig/diagrama-encrypt.png}
 \caption{Funcionamento de uma requisição de encriptação com assinatura}
 \label{fig:exemploFig2}
\end{figure}

\begin{itemize}
\item \textbf{Endpoint}: \texttt{/cryptows/encrypt-content}
\item \textbf{Método HTTP}: POST
\item \textbf{Content-type}:  \texttt{application/json}
\end{itemize}

Para criptografar um novo conteúdo deve ser enviado um objeto JSON com os seguintes atributos:


\begin{itemize}
\item \textbf{content} (String) - A mensagem que será encriptada.
\item \textbf{receiver} (String) - E-mail do destinatário da mensagem. Sua chave pública deve estar no chaveiro do Open KeyChain
\end{itemize}


\begin{center}
 \begin{minipage}{0.9\textwidth}
  \begin{codigo}[H]
   \small
   \VerbatimInput[xleftmargin=10mm,numbers=left,obeytabs=true]{./prog/1-criptografar-pedido.json}
   \caption{\texttt{Mensagem do pedido de criptografia} }
   \label{code:exemplo-json-criptografar}
  \end{codigo}
 \end{minipage}
\end{center}


A resposta deste serviço em caso de sucesso fará uso do código HTTP 200 - OK indicando que o processamento foi iniciado. A aplicação cliente receberá uma resposta com o identificador desta ação. Ele deve ser guardado e usado posteriormente para consultar o resultado do pedido de criptografia.
O formato dessa resposta conterá os seguintes dados, em formato JSON:


\begin{itemize}
\item \textbf{requestId} (String) - Identificador gerado para consulta posterior do processamento da encriptação
\item \textbf{code} (Número inteiro) - Código HTTP referente ao sucesso ou falha da operação
\item \textbf{time} (Número / Timestamp) - Timestamp do momento do recebimento da requisição pelo aplicativo no dispositivo 
\end{itemize}


\begin{center}
 \begin{minipage}{0.9\textwidth}
  \begin{codigo}[H]
   \small
   \VerbatimInput[xleftmargin=10mm,numbers=left,obeytabs=true]{./prog/2-criptografar-pedido-resposta.json}
   \caption{\texttt{Resposta do pedido de criptografia} }
   \label{code:exemplo-json-resposta-criptografar}
  \end{codigo}
 \end{minipage}
\end{center}


\subsection{Consultar resultado da criptografia de conteúdo}
\label{sec:servicoConsultaCriptografa}

Esta operação somente exige o identificador do do pedido anterior de criptografia, chamado na resposta daquele pedido de requestId. Esse identificador deve ser informado na URL de consulta.

\begin{figure}[H]
 \centering
 \includegraphics[width=0.9\textwidth]{./fig/diagrama-encrypt-consultar.png}
 \caption{Diagrama com o fluxo de consulta do resultado de uma operação de criptografia}
 \label{fig:exemploFig2}
\end{figure}


\begin{itemize}
\item \textbf{Endpoint exemplo}: \texttt{/cryptows/encrypt-content/requestId/123e4567-e89b-12d3}
\item \textbf{Método HTTP}: GET
\item \textbf{Content-type}: \texttt{application/json}
\end{itemize}


A resposta deste serviço em caso de sucesso fará uso do código HTTP 200 - OK indicando que o processamento foi concluído. Caso a aplicação no celular ainda esteja processando a requisição, o código HTTP 404 - Not Found é retornado. A aplicação cliente deve tentar novamente em alguns segundos. Em caso de retorno com sucesso a mensagem criptografada será descartada pelo serviço para poupar recursos do dispositivo móvel.
O formato dessa resposta conterá os seguintes dados, em formato JSON:

\begin{itemize}
\item \textbf{cipherContent} (String) - Mensagem criptografada com a chave pública do usuário informado em \verb|receiver|, no ato da requisição de criptografia
\item \textbf{code} (Número inteiro) - Código HTTP referente ao sucesso ou falha da operação
\item \textbf{statusMessage} (String) - Mensagem auxiliar do resultado da operação. Pode conter detalhes em caso de erros durante o processamento.
\end{itemize}


\begin{center}
 \begin{minipage}{0.9\textwidth}
  \begin{codigo}[H]
   \small
   \VerbatimInput[xleftmargin=10mm,numbers=left,obeytabs=true]{./prog/3-criptografar-consulta-ok.json}
   \caption{\texttt{Resposta do pedido de criptografia em caso de processamento concluído} }
   \label{code:exemplo-json-resposta-criptografar}
  \end{codigo}
 \end{minipage}
\end{center}



\begin{center}
 \begin{minipage}{0.9\textwidth}
  \begin{codigo}[H]
   \small
   \VerbatimInput[xleftmargin=10mm,numbers=left,obeytabs=true]{./prog/4-criptografar-consulta-404.json}
   \caption{\texttt{Resposta da consulta à pedido de criptografia ainda em andamento} }
   \label{code:exemplo-json-resposta-criptografar}
  \end{codigo}
 \end{minipage}
\end{center}


\subsection{Descriptografar uma mensagem PGP recebida}
\label{sec:servicoDescriptografa}

Esta operação demanda uma mensagem em formato OpenPGP em ASCII Armour para uma tentativa de desencriptação. O formato ASCII Armour permite que a mensagem possa ser enviada com formato JSON sem mais processamento, visto que JSON não suporta dados binário. Essa operação somente é possível se o Open KeyChain contém a chave privada equivalente à chave pública utilizada para criptografia. O conteúdo não necessariamente precisa ter sido encriptado usando o webservice apresentado no item 6.1.1, uma vez que o padrão OpenPGP não leva isso em conta.

\begin{figure}[H]
 \centering
 \includegraphics[width=0.9\textwidth]{./fig/diagrama-decrypt.png}
 \caption{Funcionamento de uma requisição de encriptação com assinatura}
 \label{fig:exemploFig2}
\end{figure}


\begin{itemize}
\item \textbf{Endpoint}: \texttt{/cryptows/decrypt-content}
\item \textbf{Método HTTP}: POST
\item \textbf{Content-type}:  \texttt{application/json}
\end{itemize}

Para descriptografar um novo conteúdo deve ser enviado um objeto JSON com os seguintes atributos:

\begin{itemize}
\item \textbf{content} (String / Mensagem OpenPGP) - A mensagem que deve ser desencriptada com uma das chaves privadas conhecidas
\end{itemize}



\begin{center}
 \begin{minipage}{0.9\textwidth}
  \begin{codigo}[H]
   \small
   \VerbatimInput[xleftmargin=10mm,numbers=left,obeytabs=true]{./prog/5-descriptografar-pedido.json}
   \caption{\texttt{Mensagem enviada para descriptografar uma mensagem OpenPGP} }
   \label{code:exemplo-json-resposta-criptografar}
  \end{codigo}
 \end{minipage}
\end{center}


A resposta deste serviço em caso de sucesso fará uso do código HTTP 200 - OK indicando que o processamento foi iniciado. A aplicação cliente receberá uma resposta com o protocolo desta ação. Ele deve ser guardado e usado posteriormente para consultar o resultado do pedido de criptografia.
O formato dessa resposta conterá os seguintes dados, em formato JSON:

\begin{itemize}
\item \textbf{requestId} (String) - Identificador gerado para consulta posterior do processamento da decriptação
\item \textbf{code} (Número inteiro) - Código HTTP referente ao sucesso ou falha da operação
\item \textbf{time} (Número / Timestamp) - Timestamp do momento do recebimento da requisição pelo aplicativo no dispositivo 
\end{itemize}


\begin{center}
 \begin{minipage}{0.9\textwidth}
  \begin{codigo}[H]
   \small
   \VerbatimInput[xleftmargin=10mm,numbers=left,obeytabs=true]{./prog/6-descriptografar-pedido-resposta.json}
   \caption{\texttt{Exemplo de resposta do pedido de descriptografia} }
   \label{code:exemplo-json-resposta-criptografar}
  \end{codigo}
 \end{minipage}
\end{center}


\subsection{Consultar resultado da descriptografia de conteúdo}
\label{sec:servicoConsultaDescriptografa}

Esta operação somente exige o identificador do do pedido anterior de criptografia, chamado na resposta daquele pedido de requestId. Esse identificador deve ser informado na URL de consulta.


\begin{figure}[H]
 \centering
 \includegraphics[width=0.9\textwidth]{./fig/diagrama-decrypt-consultar.png}
 \caption{Diagrama com o fluxo de consulta do resultado de uma operação de criptografia}
 \label{fig:exemploFig2}
\end{figure}


\begin{itemize}
\item \textbf{Endpoint exemplo}: \texttt{/cryptows/decrypt-content/requestId/123e4567-e89b-12d3}
\item \textbf{Método HTTP}: GET
\item \textbf{Content-type}:  \texttt{application/json}
\end{itemize}

A resposta deste serviço em caso de sucesso fará uso do código HTTP 200 - OK indicando que o processamento foi concluído. Caso a aplicação no celular ainda esteja em processamento a requisição, o código HTTP 404 - Not Found é retornado. A aplicação cliente deve tentar novamente em alguns segundos. 
O formato dessa resposta conterá os seguintes dados, em formato JSON:

\begin{itemize}
\item \textbf{plainContent} (String) - Mensagem descriptografada com a chave privada do usuário.
\item \textbf{code} (Número inteiro) - Código HTTP referente ao sucesso ou falha da operação
\item \textbf{statusMessage} (String) - Mensagem auxiliar do resultado da operação. Pode conter detalhes em caso de erros durante o processamento.
\end{itemize}



\begin{center}
 \begin{minipage}{0.9\textwidth}
  \begin{codigo}[H]
   \small
   \VerbatimInput[xleftmargin=10mm,numbers=left,obeytabs=true]{./prog/7-descriptografar-consulta-ok.json}
   \caption{\texttt{Exemplo de resposta em caso de processamento concluído} }
   \label{code:exemplo-json-resposta-criptografar}
  \end{codigo}
 \end{minipage}
\end{center}



\begin{center}
 \begin{minipage}{0.9\textwidth}
  \begin{codigo}[H]
   \small
   \VerbatimInput[xleftmargin=10mm,numbers=left,obeytabs=true]{./prog/8-descriptografar-consulta-404.json}
   \caption{\texttt{Exemplo de resposta em caso de processamento ainda em andamento} }
   \label{code:exemplo-json-resposta-criptografar}
  \end{codigo}
 \end{minipage}
\end{center}

